## 8.4 多体协作：多智能体框架实战

单体智能体受限于上下文窗口和角色的单一性，难以处理极其复杂的任务。这就好比一个人再厉害，也无法独自完成一部电影的拍摄。

**多智能体系统**（Multi-Agent System，简称 MAS）通过模拟人类团队的协作模式，让多个专注于不同领域的智能体共同解决问题。本节将通过实战案例，用两类代表性范式来理解多智能体框架：对话编排与角色任务编排。

### 8.4.1 对话编排范式：对话即计算

这类框架的核心特点是 **对话即计算**：智能体通过对话驱动任务推进，并结合受控执行环境实现“生成→执行→反馈→修复”的闭环。

#### 核心概念：执行代理与规划代理

一种常见抽象是把系统拆成两个基本角色：

1. **规划/生成代理**：负责分析、规划与生成代码/操作。
2. **执行代理**：负责在沙箱中执行、收集结果与报错并回传。

**工作流**：
1. 任务：“请画一张股价走势图”。
2. Assistant：生成一段 Python 代码。
3. 执行代理：自动捕获代码，在受控沙箱中运行，报错提示“缺少依赖”。
4. 执行代理：将报错信息发回给 Assistant。
5. Assistant: “抱歉，我忘了安装库。这是修正后的代码...”
6. 执行代理：运行成功，生成图表文件。
7. 循环结束。

#### 适用场景与风险

这种范式适合“需要在环境中反复试错”的任务，例如编程、数据分析与自动化操作。但也要注意两类风险：

- **成本失控**：一旦陷入重试循环，Token 与工具成本可能快速飙升，需要步数上限与熔断。
- **安全边界**：执行代理必须在沙箱内运行，并对文件、网络与高风险操作设置硬限制。

### 8.4.2 实战：构建自动编程团队


```python
# 伪代码示例：用"群聊编排"构建自动编程团队

pm = Agent(name="Product_Manager", system="把需求拆成可实现的功能点")
coder = Agent(name="Coder", system="根据功能点编写代码，并给出运行/测试方式")
executor = Agent(name="Executor", system="在沙箱中运行代码、收集报错并回传")

group = GroupChat(agents=[executor, pm, coder], max_rounds=12)

group.start(message="我想做一个简单的贪吃蛇游戏。")
# 循环：pm -> coder -> executor(运行/报错) -> coder(修复) -> ... -> 产出可运行程序
```

**运行结果**：PM 会先列出功能点，Coder 接着写代码，UserProxy 尝试运行，如果报错 Coder 会自动修。你会看到这三个“人”在屏幕上快速刷屏对话，最后直接在目录下生成一个可运行的 `snake.py`。

### 8.4.3 角色任务编排范式：像导演一样编排团队

另一类框架更强调 **角色扮演** 与 **任务流编排**：先定义谁做什么、每步交付什么，再把任务按顺序或层级组织起来。

#### 核心概念：角色、任务、工作流

这类框架通常要求你先回答三个问题：
1. **Who**：谁来做？例如角色、目标、背景设定。
2. **What**：做什么？例如任务描述、预期输出。
3. **How**：怎么配合？例如顺序式或层级式流程。

#### 模板化与验收标准

为了让角色任务编排在生产环境中可控，建议把“角色卡”“交付物模板”“验收清单”做成可复用模板，并在每个关键节点进行自动校验（格式、字段完整性、引用证据、风险动作审批等）。

### 8.4.4 实战：构建市场调研团队


```python
# 伪代码示例：用"角色 + 任务流"构建市场调研团队

researcher = Agent(role="研究员", goal="收集信息并给出可验证依据")
writer = Agent(role="写作者", goal="把研究结果组织成可读文章")

task1 = Task(description="调研某主题的关键趋势", agent=researcher)
task2 = Task(description="基于调研产出文章", agent=writer, input_from=task1)

crew = Workflow(agents=[researcher, writer], tasks=[task1, task2], mode="sequential")
result = crew.run()
print(result)
```

### 8.4.5 两类范式对比

| 维度 | 对话编排范式 | 角色任务编排范式 |
| :--- | :--- | :--- |
| **强项** | 生成-执行闭环、快速迭代修复 | 角色分工清晰、流程可控 |
| **交互模式** | 对话流（自由度高） | 任务流（结构化更强） |
| **底层** | 框架自带编排 | 依赖通用组件/生态 |
| **上手难度** | 取决于沙箱/工具链集成复杂度 | 取决于流程抽象与模板完善度 |

### 8.4.6 小结

多智能体系统不仅是“人多力量大”，更是 **分而治之** 思想的体现。
- 通过让 Researcher 专注搜索，Writer 专注写作，每个智能体的系统提示词 (System Prompt) 都可以更短、更聚焦，从而降低幻觉，提升质量。
- 一类框架更偏“执行闭环”（写代码/跑代码/修复）。
- 一类框架更偏“角色流程”（研究→写作→审阅→交付）。

下节将探讨如何将这些智能体集成到现有的企业系统中。

---

**下一节**: [8.5 企业级集成：与现有系统整合](8.5_enterprise.md)
