## 4.3 MCP：模型上下文协议

MCP（Model Context Protocol）是 Anthropic 在 2024 年底推出的开放标准，旨在统一 AI 应用与外部数据源和工具的连接方式。它类似于 AI 领域的"USB 接口"，让不同的模型和工具可以通过标准协议互联互通。

> [!IMPORTANT]
> **行业里程碑**：2025年12月，Anthropic 将 MCP 正式捐赠给 Linux Foundation 的 **Agentic AI Foundation (AAIF)**。MCP 已从单一厂商的开源项目升级为由 AWS、Google、Microsoft、OpenAI 等共同治理的行业标准协议。

### 4.3.1 MCP 的行业采用

MCP 在发布一年内迅速成为 AI 工具集成的事实标准：

### 4.3.2 采用平台

| 平台类型 | 采用者 |
|---------|--------|
| AI 对话 | Claude, ChatGPT, Gemini |
| 代码编辑器 | Cursor, VS Code, Windsurf, Zed |
| 企业服务 | Microsoft Copilot, AWS, Google Cloud, Azure |

### 4.3.3 生态规模

- **10,000+** 已发布的 MCP 服务器
- 覆盖开发工具到 Fortune 500 企业部署
- 所有主流 AI 平台均已支持

### 4.3.4 行业领袖评价

> "MCP 是 AI Agent 时代 API 的基础构建块。作为 Linux Foundation 治理的开放标准，MCP 将推动金融领域更广泛的采用和创新。"  
> — **Shawn Edwards**, Bloomberg 首席技术官

> "开放标准和协议如 MCP 对于构建繁荣的 Agent 开发者生态至关重要——它们确保任何人都可以跨平台构建 Agent，而无需担心供应商锁定。"  
> — **Dane Knecht**, Cloudflare 首席技术官

### 4.3.5 什么是 MCP

#### 问题背景

在 MCP 出现之前，每个 AI 应用都需要：
- 为每个数据源单独开发连接器
- 为每个工具实现特定的集成代码
- 在不同平台之间重复造轮子

```
Before MCP:
┌─────────┐    定制接口1    ┌─────────────┐
│  App A  │ ──────────────→ │  数据源 1    │
│         │    定制接口2    ├─────────────┤
│         │ ──────────────→ │  数据源 2    │
└─────────┘                 └─────────────┘

┌─────────┐    定制接口3    ┌─────────────┐
│  App B  │ ──────────────→ │  数据源 1    │
│         │    定制接口4    ├─────────────┤
│         │ ──────────────→ │  数据源 2    │
└─────────┘                 └─────────────┘
```

### 4.3.6 MCP 的解决方案

MCP 定义了一个标准化的协议，任何符合协议的服务都可以无缝连接：

```
After MCP:
┌─────────┐                 ┌─────────────┐
│  App A  │ ──┐             │  MCP Server │
│         │   │    MCP      │  (数据源 1)  │
└─────────┘   │  Protocol   └─────────────┘
              ├──────────→  ┌─────────────┐
┌─────────┐   │             │  MCP Server │
│  App B  │ ──┘             │  (数据源 2)  │
│         │                 └─────────────┘
└─────────┘
```

#### MCP 核心概念

### 4.3.7 架构组成

```
┌──────────────────────────────────────────────────────────┐
│                      MCP Host                            │
│                  (如 Claude Desktop)                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                   MCP Client                         │ │
│  │              (协议客户端实现)                         │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                           │
                    MCP Protocol
                    (JSON-RPC 2.0)
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │ MCP Server │  │ MCP Server │  │ MCP Server │
    │  (GitHub)  │  │ (Database) │  │  (Files)   │
    └────────────┘  └────────────┘  └────────────┘
```

### 4.3.8 三种核心能力

MCP Server 可以提供三种类型的能力：

#### Resources（资源）

只读数据，类似文件系统：

```json
{
  "resources": [
    {
      "uri": "file:///project/README.md",
      "name": "项目说明",
      "mimeType": "text/markdown"
    },
    {
      "uri": "postgres://db/users",
      "name": "用户表"
    }
  ]
}
```

#### Tools（工具）

可执行的操作：

```json
{
  "tools": [
    {
      "name": "query_database",
      "description": "执行 SQL 查询",
      "inputSchema": {
        "type": "object",
        "properties": {
          "sql": {"type": "string"}
        },
        "required": ["sql"]
      }
    }
  ]
}
```

#### Prompts（提示模板）

预定义的交互模板：

```json
{
  "prompts": [
    {
      "name": "code_review",
      "description": "代码审查模板",
      "arguments": [
        {"name": "code", "required": true}
      ]
    }
  ]
}
```

### 4.3.9 实现 MCP Server

#### Python 示例

使用官方 `mcp` 库创建一个简单的 MCP Server：

```python
# server.py
from mcp.server.fastmcp import FastMCP

# 创建 MCP 服务器
mcp = FastMCP("My MCP Server")

# 定义工具
@mcp.tool()
def get_weather(city: str) -> str:
    """获取指定城市的天气信息
    
    Args:
        city: 城市名称
    
    Returns:
        天气信息字符串
    """
    # 实际实现中调用天气 API
    return f"{city}今天晴，气温 22°C"

@mcp.tool()
def search_notes(query: str, limit: int = 10) -> list:
    """搜索笔记
    
    Args:
        query: 搜索关键词
        limit: 返回结果数量
    
    Returns:
        匹配的笔记列表
    """
    # 实际实现中搜索数据库
    return [{"title": f"Note about {query}", "content": "..."}]

# 定义资源
@mcp.resource("notes://{note_id}")
def get_note(note_id: str) -> str:
    """获取指定笔记内容"""
    return f"Note content for {note_id}"

# 定义提示模板
@mcp.prompt()
def summarize_notes(topic: str) -> str:
    """生成笔记摘要的提示模板"""
    return f"""请总结关于 "{topic}" 的所有笔记内容，包括：
1. 主要观点
2. 关键信息
3. 待办事项"""

if __name__ == "__main__":
    mcp.run()
```

### 4.3.10 配置 Claude Desktop

在 Claude Desktop 中使用 MCP Server：

```json
// ~/.config/claude/claude_desktop_config.json (macOS)
// %APPDATA%\Claude\claude_desktop_config.json (Windows)

{
  "mcpServers": {
    "my-notes": {
      "command": "python",
      "args": ["/path/to/server.py"],
      "env": {
        "API_KEY": "your-api-key"
      }
    },
    "weather": {
      "command": "npx",
      "args": ["-y", "@mcp/weather-server"]
    }
  }
}
```

### 4.3.11 已有的 MCP Server 生态

### 4.3.12 官方维护的 Server

| Server | 功能 | 安装方式 |
|--------|------|----------|
| `@modelcontextprotocol/server-filesystem` | 文件系统访问 | npx |
| `@modelcontextprotocol/server-github` | GitHub 集成 | npx |
| `@modelcontextprotocol/server-postgres` | PostgreSQL 查询 | npx |
| `@modelcontextprotocol/server-slack` | Slack 消息 | npx |
| `@modelcontextprotocol/server-memory` | 持久化记忆 | npx |

### 4.3.13 社区 Server

- **Obsidian MCP**：Obsidian 笔记管理
- **Notion MCP**：Notion 页面操作
- **Raycast MCP**：Raycast 扩展集成
- **Browser MCP**：浏览器自动化

#### MCP 的优势

#### 1. 标准化

一次开发，处处可用：

```
开发者只需实现一次 MCP Server
     │
     ├─ Claude Desktop 可用
     ├─ Cursor/Windsurf 可用
     ├─ 自研应用可用
     └─ 任何支持 MCP 的客户端可用
```

#### 2. 安全性

- **本地运行**：Server 运行在用户本地，数据不外泄
- **权限控制**：Host 可以控制 Server 的权限
- **审计日志**：所有调用都可被记录

#### 3. 可组合性

多个 Server 可以协同工作：

```
用户请求："总结我今天的 GitHub 提交，并更新到 Notion"
     │
     ├─ GitHub Server: 获取今日提交
     │
     ├─ AI 处理: 生成总结
     │
     └─ Notion Server: 创建页面
```

### 4.3.14 MCP 与 Function Calling 的区别

| 维度 | Function Calling | MCP |
|------|-----------------|-----|
| 定义位置 | 每次 API 调用时传入 | 独立的服务定义 |
| 执行位置 | 客户端或服务端 | 标准化的 Server |
| 标准化程度 | 各平台不同 | 统一协议 |
| 复用性 | 需要重复定义 | 一次定义多处使用 |
| 生态 | 各平台独立 | 共享的 Server 生态 |

#### 最佳实践

#### 1. Server 设计

```python
# ✅ 好的设计：功能聚焦
class NotesServer:
    """专注于笔记管理的 MCP Server"""
    
    def search_notes(self, query): pass
    def create_note(self, title, content): pass
    def update_note(self, note_id, content): pass

# ❌ 不好的设计：功能过于宽泛
class EverythingServer:
    """什么都做的 Server"""
    
    def search_notes(self): pass
    def send_email(self): pass
    def query_database(self): pass
```

#### 2. 错误处理

```python
@mcp.tool()
def query_database(sql: str) -> dict:
    try:
        result = db.execute(sql)
        return {"success": True, "data": result}
    except SQLSyntaxError as e:
        return {
            "success": False,
            "error": "SQL 语法错误",
            "details": str(e),
            "suggestion": "请检查 SQL 语法"
        }
    except PermissionError:
        return {
            "success": False,
            "error": "权限不足",
            "suggestion": "该表不允许查询"
        }
```

#### 3. 文档完善

```python
@mcp.tool()
def create_issue(
    title: str,
    body: str,
    labels: list = None,
    assignees: list = None
) -> dict:
    """在 GitHub 仓库创建新 Issue
    
    创建一个新的 GitHub Issue。需要仓库的写入权限。
    
    Args:
        title: Issue 标题，建议不超过 100 字符
        body: Issue 正文，支持 Markdown 格式
        labels: 标签列表，如 ["bug", "high-priority"]
        assignees: 指派人列表，使用 GitHub 用户名
    
    Returns:
        包含创建的 Issue 信息的字典，包括:
        - issue_number: Issue 编号
        - url: Issue 链接
        - created_at: 创建时间
    
    Raises:
        AuthenticationError: API token 无效
        PermissionError: 无仓库写入权限
        ValidationError: 参数格式错误
    
    Example:
        create_issue(
            title="登录按钮无响应",
            body="## 问题描述\n点击登录按钮没有反应...",
            labels=["bug"],
            assignees=["developer1"]
        )
    """
    pass
```

### 4.3.15 小结

MCP 是智能体工具生态的重要标准化尝试，现已成为行业标准：

1. **统一接口**：一个协议连接所有工具和数据源
2. **生态共享**：社区贡献的 Server 可直接使用
3. **安全可控**：本地运行，权限可控
4. **行业认可**：由 Linux Foundation AAIF 治理，AWS、Google、Microsoft 等共同参与
5. **面向未来**：成为 AI 应用的"USB 标准"

> [!TIP]
> **相关资源**：
> - AAIF 官网：https://aaif.io
> - MCP 规范：https://github.com/modelcontextprotocol
> - MCP 服务器目录：https://github.com/modelcontextprotocol/servers

下一节我们将探讨代码解释器与沙箱环境的实现。

---

**下一节**: [代码解释器与沙箱环境](4.4_code_interpreter.md)