## 4.3 工具连接协议：模型上下文与工具服务

当智能体需要访问外部世界（数据库、文件、知识库、SaaS）时，最大的工程痛点往往不是“能不能调 API”，而是**如何在不同工具之间用一致方式描述能力、传递上下文、处理错误与权限**。

本节介绍一类“工具连接协议”的通用思路：把工具与数据源以标准化结构暴露给智能体宿主，让不同模型与不同工具更容易互联互通。

### 4.3.1 什么是工具连接协议 (以 MCP 为例)

随着智能体生态的发展，业界急需一种连接标准。其中，由 Anthropic 牵头的 **Model Context Protocol (MCP)** 正在迅速成为事实上的行业标准。本节探讨的理念适用于各类工具互操作协议，但我们将以 MCP 的核心设计为代表蓝本来阐述。

在缺乏统一协议时，常见痛点包括：

- **重复造轮子**：每个应用为每个数据源单独开发连接器。
- **语义不一致**：同一类工具在不同系统里参数、错误码与返回结构不同。
- **权限难治理**：鉴权方式分散，审计事件不统一。
- **难以复用**：一个工具的集成难以迁移到另一个宿主或框架。

### 4.3.2 从静态集成到动态发现

工具连接协议的一个关键收益是从“静态硬编码”走向“动态发现”：

- **静态硬编码**：开发者手写每个工具的描述、参数格式、错误处理与权限边界。
- **动态发现**：宿主在运行时向工具服务询问：你能提供什么资源？你有哪些操作？输入输出结构是什么？需要什么权限？

这使得智能体可以在复杂的企业数据库、本地文件系统和第三方服务之间更容易切换，降低集成成本。

### 4.3.3 协议能力结构

一个实用的工具连接协议通常包含三类能力：资源、工具、提示模板。

#### 1. 资源（Resources）

资源代表只读或受限读写的数据项，例如文件、表、文档、记录集合。

```json
{
  "resources": [
    {"uri": "file:///project/README.md", "name": "项目说明", "mimeType": "text/markdown"},
    {"uri": "db://users", "name": "用户表"}
  ]
}
```

#### 2. 工具（Tools）

工具代表可执行的操作，例如查询、写入、创建工单、发送消息。

```json
{
  "tools": [
    {
      "name": "query_database",
      "description": "执行查询",
      "inputSchema": {
        "type": "object",
        "properties": {"sql": {"type": "string"}},
        "required": ["sql"]
      }
    }
  ]
}
```

#### 3. 提示模板（Prompts）

提示模板用于把“可复用的交互模式”沉淀为结构化模板，避免每次从零写提示词。

```json
{
  "prompts": [
    {
      "name": "summarize_ticket",
      "description": "总结工单并输出结构化要点",
      "arguments": [{"name": "ticket_id", "type": "string"}]
    }
  ]
}
```

### 4.3.4 宿主、协议与工具服务

工具连接协议通常把系统拆成三层：

1. **宿主（Host）**：承载智能体运行的环境（IDE、CLI、服务端）。
2. **协议层（Protocol）**：负责发现、调用与事件回传。
3. **工具服务（Server）**：暴露资源与工具的具体实现。

```mermaid
graph TD
    classDef agent fill:#e6f7ff,stroke:#1890ff,stroke-width:2px;
    classDef tool fill:#f6ffed,stroke:#52c41a,stroke-width:2px;
    classDef system fill:#f0f0f0,stroke:#d9d9d9,stroke-width:2px;

    Host[宿主：IDE/CLI/服务端]:::system --> Agent[智能体]:::agent
    Host --> Protocol[工具连接协议]:::system
    Protocol --> S1[工具服务：文件]:::tool
    Protocol --> S2[工具服务：数据库]:::tool
    Protocol --> S3[工具服务：知识库]:::tool
```

图 4-6：工具连接协议分层示意

### 4.3.5 安全基线与漏洞防范

随着工具连接协议（如 MCP）允许智能体接入越来越底层的企业系统资源，**工具的安全性不能仅依赖大模型的“判断力”或系统提示词“警告”，必须在协议与服务实现层建立硬护栏**。

> [!WARNING]
> **真实漏洞警示：目录遍历与越权**
> 在早期的某些开源 MCP Filesystem / Git Server 实现中，曾暴露出严重的沙箱逃逸漏洞：由于工具底层缺乏对传入路径参数的严格清洗（例如未能拦截 `../` 等目录跳转字符），导致智能体由于产生幻觉或被攻击，通过合法通道绕过了预期工作区限制，读取了宿主机的高维敏感文件（如 `~/.ssh/id_rsa`），甚至触发了任意命令执行。

为了保证生产安全，必须在工具接入体系中强制实施如下 **安全基线**：

1. **强白名单机制（Path Whitelists & Boundary Enforcement）**
   - 任何涉及文件、系统进程、URL 访问的操作，必须被约束在极严苛的沙箱目录或白名单域列表中。任何试图“跳出”边界（如使用绝对路径覆盖、恶意参数注入）的动作，必须在工具服务内部直接熔断拦截。
   
2. **最小权限原则（Least Privilege IAM）**
   - 绝不赋予智能体超出生存期需要的权限。如果一个 Agent 仅需要根据代码库生成文档，就只给它读权限（Read-Only MCP Server），绝对不要将具有“提交、删除”能力的写权限工具暴露给它。
   - 企业数据库查询工具，在后端链路上必须降权使用仅具有 SELECT 权限的极低权限数据库账号。

3. **速率控制与熔断防御（Rate Limits & Quota）**
   - 智能体在面对未知错误时极易陷入无限循环（如 ReAct 的重试风暴）。若无防护，一个出 Bug 的智能体可能在几分钟内发起百万次调用，打垮企业内部核心系统。
   - 对于每个 Agent Session 或租户，必须在协议接入网关强制配置 API 级别的速率限制（Rate Limits）与熔断条件。

### 4.3.6 最佳实践

- **单一职责**：一个工具服务聚焦一个领域，避免“巨无霸工具服务”。
- **结构化错误**：返回机器可读的错误类型与建议，减少智能体盲目重试。
- **权限前置**：在工具服务侧做硬权限校验，不把安全寄托在提示词。
- **可观测性统一**：为每次调用打上 `trace_id`，支持跨系统回放与排障。
- **与技能协同**：协议解决“连接与调用”，技能解决“流程与最佳实践”。

---

**下一节**: [4.4 Agent Skills：能力扩展规范](4.4_skills.md)
