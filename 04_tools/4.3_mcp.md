## 4.3 MCP：模型上下文协议

**模型上下文协议（Model Context Protocol, MCP）** 是 Anthropic 在 2024 年底推出的开放标准，旨在统一 AI 应用与外部数据源和工具的连接方式。它类似于 AI 领域的"USB 接口"，让不同的模型和工具可以通过标准协议互联互通。

> [!IMPORTANT]
> **行业里程碑**：2025年12月，Anthropic 将 MCP 正式捐赠给 Linux Foundation 的 **智能体 AI 基金会（Agentic AI Foundation, AAIF）**。MCP 已从单一厂商的开源项目升级为由 AWS、Google、Microsoft、OpenAI 等共同治理的行业标准协议。

### 4.3.1 MCP 的行业采用

MCP 在发布两年内迅速成为 AI 工具集成的事实标准。

#### 采用平台

| 平台类型 | 采用者 |
|---------|--------|
| AI 对话 | Claude, ChatGPT, Gemini |
| 代码编辑器 | Cursor, VS Code, Windsurf, Zed |
| 企业服务 | Microsoft Copilot, AWS, Google Cloud, Azure |

#### 生态规模

- **10,000+** 已发布的 MCP 服务器
- 覆盖开发工具到 Fortune 500 企业部署
- 所有主流 AI 平台均已支持

#### 行业领袖评价

> "MCP 是智能体 AI 时代 API 的基础构建块。作为 Linux Foundation 治理的开放标准，MCP 将推动金融领域更广泛的采用和创新。"  
> — **Shawn Edwards**, Bloomberg 首席技术官

> "开放标准和协议如 MCP 对于构建繁荣的智能体开发者生态至关重要——它们确保任何人都可以跨平台构建智能体，而无需担心供应商锁定。"  
> — **Dane Knecht**, Cloudflare 首席技术官

### 4.3.2 什么是 MCP

#### 问题背景

在 MCP 出现之前，每个 AI 应用都需要：

- 为每个数据源单独开发连接器
- 为每个工具实现特定的集成代码
- 在不同平台之间重复造轮子

```
Before MCP:
┌─────────┐    定制接口1    ┌─────────────┐
│  App A  │ ──────────────→ │  数据源 1    │
│         │    定制接口2    ├─────────────┤
│         │ ──────────────→ │  数据源 2    │
└─────────┘                 └─────────────┘

┌─────────┐    定制接口3    ┌─────────────┐
│  App B  │ ──────────────→ │  数据源 1    │
│         │    定制接口4    ├─────────────┤
│         │ ──────────────→ │  数据源 2    │
└─────────┘                 └─────────────┘
```

#### MCP 的解决方案

MCP 定义了一个标准化的协议，任何符合协议的服务都可以无缝连接：

```
After MCP:
┌─────────┐                 ┌─────────────┐
│  App A  │ ──┐             │  MCP Server │
│         │   │    MCP      │  (数据源 1)  │
└─────────┘   │  Protocol   └─────────────┘
              ├──────────→  ┌─────────────┐
┌─────────┐   │             │  MCP Server │
│  App B  │ ──┘             │  (数据源 2)  │
│         │                 └─────────────┘
└─────────┘
```

### 4.3.3 MCP 核心概念

#### 架构组成

```
┌──────────────────────────────────────────────────────────┐
│                      MCP Host                            │
│                  (如 Claude Desktop)                      │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                   MCP Client                         │ │
│  │              (协议客户端实现)                         │ │
│  └─────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────┘
                           │
                    MCP Protocol
                    (JSON-RPC 2.0)
                           │
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌────────────┐  ┌────────────┐  ┌────────────┐
    │ MCP Server │  │ MCP Server │  │ MCP Server │
    │  (GitHub)  │  │ (Database) │  │  (Files)   │
    └────────────┘  └────────────┘  └────────────┘
```

#### 三种核心能力

MCP Server 可以提供三种类型的能力：

**资源 (Resources)**：只读数据，类似文件系统：

```json
{
  "resources": [
    {
      "uri": "file:///project/README.md",
      "name": "项目说明",
      "mimeType": "text/markdown"
    },
    {
      "uri": "postgres://db/users",
      "name": "用户表"
    }
  ]
}
```

**工具 (Tools)**：可执行的操作：

```json
{
  "tools": [
    {
      "name": "query_database",
      "description": "执行 SQL 查询",
      "inputSchema": {
        "type": "object",
        "properties": {
          "sql": {"type": "string"}
        },
        "required": ["sql"]
      }
    }
  ]
}
```

**提示模板 (Prompts)**：预定义的交互模板：

```json
{
  "prompts": [
    {
      "name": "code_review",
      "description": "代码审查模板",
      "arguments": [
        {"name": "code", "required": true}
      ]
    }
  ]
}
```

### 4.3.4 实现 MCP Server

#### Python 示例

使用官方 `mcp` 库创建一个简单的 MCP Server：

```python
# server.py
from mcp.server.fastmcp import FastMCP

# 创建 MCP 服务器
mcp = FastMCP("My MCP Server")

# 定义工具
@mcp.tool()
def get_weather(city: str) -> str:
    """获取指定城市的天气信息
    
    Args:
        city: 城市名称
    
    Returns:
        天气信息字符串
    """
    # 实际实现中调用天气 API
    return f"{city}今天晴，气温 22°C"

@mcp.tool()
def search_notes(query: str, limit: int = 10) -> list:
    """搜索笔记
    
    Args:
        query: 搜索关键词
        limit: 返回结果数量
    
    Returns:
        匹配的笔记列表
    """
    # 实际实现中搜索数据库
    return [{"title": f"Note about {query}", "content": "..."}]

# 定义资源
@mcp.resource("notes://{note_id}")
def get_note(note_id: str) -> str:
    """获取指定笔记内容"""
    return f"Note content for {note_id}"

# 定义提示模板
@mcp.prompt()
def summarize_notes(topic: str) -> str:
    """生成笔记摘要的提示模板"""
    return f"""请总结关于 "{topic}" 的所有笔记内容，包括：
1. 主要观点
2. 关键信息
3. 待办事项"""

if __name__ == "__main__":
    mcp.run()
```

#### 配置 Claude Desktop

在 Claude Desktop 中使用 MCP Server：

```json
// ~/.config/claude/claude_desktop_config.json (macOS)
// %APPDATA%\Claude\claude_desktop_config.json (Windows)

{
  "mcpServers": {
    "my-notes": {
      "command": "python",
      "args": ["/path/to/server.py"],
      "env": {
        "API_KEY": "your-api-key"
      }
    },
    "weather": {
      "command": "npx",
      "args": ["-y", "@mcp/weather-server"]
    }
  }
}
```

#### MCP Server 生态

**官方维护的 Server**：

| Server | 功能 | 安装方式 |
|--------|------|----------|
| `@modelcontextprotocol/server-filesystem` | 文件系统访问 | npx |
| `@modelcontextprotocol/server-github` | GitHub 集成 | npx |
| `@modelcontextprotocol/server-postgres` | PostgreSQL 查询 | npx |
| `@modelcontextprotocol/server-slack` | Slack 消息 | npx |
| `@modelcontextprotocol/server-memory` | 持久化记忆 | npx |

**社区 Server**：

- **Obsidian MCP**：Obsidian 笔记管理
- **Notion MCP**：Notion 页面操作
- **Raycast MCP**：Raycast 扩展集成
- **Browser MCP**：浏览器自动化

### 4.3.5 MCP 的优势与最佳实践

#### 标准化

一次开发，处处可用：

```
开发者只需实现一次 MCP Server
     │
     ├─ Claude Desktop 可用
     ├─ Cursor/Windsurf 可用
     ├─ 自研应用可用
     └─ 任何支持 MCP 的客户端可用
```

#### 安全性

- **本地运行**：Server 运行在用户本地，数据不外泄
- **权限控制**：Host 可以控制 Server 的权限
- **审计日志**：所有调用都可被记录

#### 可组合性

多个 Server 可以协同工作：

```
用户请求："总结我今天的 GitHub 提交，并更新到 Notion"
     │
     ├─ GitHub Server: 获取今日提交
     │
     ├─ AI 处理: 生成总结
     │
     └─ Notion Server: 创建页面
```

#### MCP 与 Function Calling 的区别

| 维度 | 函数调用 (Function Calling) | MCP |
|------|-----------------|-----|
| 定义位置 | 每次 API 调用时传入 | 独立的服务定义 |
| 执行位置 | 客户端或服务端 | 标准化的 Server |
| 标准化程度 | 各平台不同 | 统一协议 |
| 复用性 | 需要重复定义 | 一次定义多处使用 |
| 生态 | 各平台独立 | 共享的 Server 生态 |

#### Server 设计最佳实践

```python
# ✅ 好的设计：功能聚焦
class NotesServer:
    """专注于笔记管理的 MCP Server"""
    
    def search_notes(self, query): pass
    def create_note(self, title, content): pass
    def update_note(self, note_id, content): pass

# ❌ 不好的设计：功能过于宽泛
class EverythingServer:
    """什么都做的 Server"""
    
    def search_notes(self): pass
    def send_email(self): pass
    def query_database(self): pass
```

#### 错误处理

```python
@mcp.tool()
def query_database(sql: str) -> dict:
    try:
        result = db.execute(sql)
        return {"success": True, "data": result}
    except SQLSyntaxError as e:
        return {
            "success": False,
            "error": "SQL 语法错误",
            "details": str(e),
            "suggestion": "请检查 SQL 语法"
        }
    except PermissionError:
        return {
            "success": False,
            "error": "权限不足",
            "suggestion": "该表不允许查询"
        }
```

#### 文档完善

```python
@mcp.tool()
def create_issue(
    title: str,
    body: str,
    labels: list = None,
    assignees: list = None
) -> dict:
    """在 GitHub 仓库创建新 Issue
    
    创建一个新的 GitHub Issue。需要仓库的写入权限。
    
    Args:
        title: Issue 标题，建议不超过 100 字符
        body: Issue 正文，支持 Markdown 格式
        labels: 标签列表，如 ["bug", "high-priority"]
        assignees: 指派人列表，使用 GitHub 用户名
    
    Returns:
        包含创建的 Issue 信息的字典，包括:
        - issue_number: Issue 编号
        - url: Issue 链接
        - created_at: 创建时间
    
    Raises:
        AuthenticationError: API token 无效
        PermissionError: 无仓库写入权限
        ValidationError: 参数格式错误
    
    Example:
        create_issue(
            title="登录按钮无响应",
            body="## 问题描述\n点击登录按钮没有反应...",
            labels=["bug"],
            assignees=["developer1"]
        )
    """
    pass
```

### 4.3.6 MCP 与 Skills 的协同关系

MCP 和 Skills 是互补而非竞争的关系。MCP 解决"通过什么做"的问题，Skills 解决"如何做"的问题。

#### 硬件店比喻

想象你走进一家五金店修理坏掉的橱柜。店里有你需要的所有东西（木胶、夹具、更换铰链），但知道买哪些物品以及如何使用它们是另一个问题。

- **MCP 像货架通道**：提供对所有库存的访问权限
- **Skills 像店员的专业知识**：引导你完成修理流程，指出正确的用品，展示正确的技术

更具体地说，MCP Server 让 Claude 访问外部系统、服务和平台，而 Skills 提供 Claude 有效使用这些连接所需的上下文，教 Claude 如何利用这些访问权限做事。

#### 能力边界划分

| 维度 | MCP 负责 | Skills 负责 |
|------|---------|-----------| 
| 定位 | 连接能力 | 领域知识 |
| 解决问题 | 如何访问工具 | 如何有效使用工具 |
| 内容 | API 格式、查询语法 | 工作流程、业务规则 |
| 指令范围 | 工具使用提示（通用） | 多工具编排逻辑（特定） |
| 粒度 | 单个服务 | 跨服务流程 |

**经验法则**：

- MCP 指令覆盖**如何正确使用服务器及其工具**
- Skills 指令覆盖**如何在特定流程或多服务器工作流中使用它们**

#### 协同工作的优势

当 Skills 和 MCP 结合使用时，可获得：

**清晰的发现机制**：Claude 不再猜测该查找什么。会议准备 Skill 可能指定：先检查项目页面，然后检查以前的会议记录，再检查利益相关者资料。研究 Skill 可能说：从共享驱动器开始，与 CRM 交叉引用，然后用网络搜索填补空白。Skill 编码了关于哪些来源对哪些任务重要的机构知识。

**可靠的编排**：多步骤工作流变得可预测。没有 Skill，Claude 可能在检查是否拥有一切之前就拉取数据并格式化。Skills 明确定义序列，因此 Claude 每次都以相同的方式执行工作流。

**一致的性能**：输出实际满足标准。通用结果需要编辑。Skills 为你的团队定义"完成"的样子：正确的结构、正确的详细程度、适合受众的正确语气。

#### 实际协同案例

**财务分析：公司估值自动化**

Anthropic 发布了一套用于常见财务工作流的预构建 Skills，包括可比公司分析。这是一种标准估值方法，分析师需要花费数小时从多个来源提取财务指标，应用相同的估值方法论，并格式化输出以满足合规标准。

- **Skill**：Comparable Company Analysis，自动化估值工作流，从多个来源提取数据，应用一致的方法，格式化输出到特定标准
- **MCP Servers**：连接到 S&P Capital IQ、Daloopa、Morningstar 获取实时市场数据
- **工作流**：
  1. Skill 识别要查询哪些数据源（发现）
  2. MCP 连接拉取实时财务数据
  3. Skill 应用方法论并格式化输出（编排）
  4. Skill 根据合规要求验证（性能）

**会议准备：Notion 的 Meeting Intelligence Skill**

会议准备很繁琐。你需要从多个地方提取上下文，如项目文档、以前的会议记录和利益相关者信息，然后将其综合成预读材料和议程。这是一种多步骤流程，你每次都需要重新解释。

- **Skill**：Meeting Intelligence，定义要搜索哪些页面、如何构建输出、包含哪些部分
- **MCP Server**：Notion 连接，搜索、读取和创建页面
- **工作流**：
  1. Skill 识别要搜索的相关页面，包括项目、以前的会议、利益相关者信息（发现）
  2. MCP 连接从 Notion 搜索和检索内容
  3. Skill 构建两个文档：内部预读和外部议程（编排）
  4. MCP 连接将两个文档保存到 Notion，有组织且链接
  5. Skill 确保输出符合格式标准（性能）

#### 避免指令冲突

MCP Server 可能包含以工具使用提示和常见任务提示形式的指令。这使工具特定知识靠近工具。然而，这些指令在设计上应保持通用性。

**规则**：MCP 指令涵盖如何正确使用服务器及其工具。Skill 指令涵盖如何在给定流程或多服务器工作流中使用它们。

例如，Salesforce MCP Server 可能指定查询语法和 API 格式。Skill 会指定首先检查哪些记录，如何根据最近上下文的 Slack 对话交叉引用它们，以及如何为团队的管道审查构建输出。

当组合 MCP Server 和 Skills 时，注意冲突的指令。如果你的 MCP Server 说返回 JSON，而你的 Skill 说格式化为 Markdown 表格，Claude 必须猜测哪个是正确的。让 MCP 处理连接，让 Skills 处理呈现、排序和工作流逻辑。

### 4.3.7 小结

MCP 是智能体工具生态的重要标准化尝试，现已成为行业标准：

1. **统一接口**：一个协议连接所有工具和数据源
2. **生态共享**：社区贡献的 Server 可直接使用
3. **安全可控**：本地运行，权限可控
4. **行业认可**：由 Linux Foundation AAIF 治理，AWS、Google、Microsoft 等共同参与
5. **面向未来**：成为 AI 应用的"USB 标准"
6. **与 Skills 互补**：MCP 提供"通道"，Skills 提供"智慧"

> [!TIP]
> **相关资源**：
> - AAIF 官网：https://aaif.io
> - MCP 规范：https://github.com/modelcontextprotocol
> - MCP 服务器目录：https://github.com/modelcontextprotocol/servers

下一节我们将探讨智能体技能 (Agent Skills) 能力扩展规范。

---

**下一节**: [Agent Skills：能力扩展规范](4.4_skills.md)