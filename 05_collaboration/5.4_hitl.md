## 5.4 äººæœºåä½œ

**å®Œå…¨è‡ªä¸»çš„æ™ºèƒ½ä½“** å¹¶ä¸æ€»æ˜¯æœ€ä½³é€‰æ‹©ã€‚åœ¨é«˜é£é™©å†³ç­–ã€åˆ›æ„æ€§å·¥ä½œæˆ–éœ€è¦æœ€ç»ˆç¡®è®¤çš„åœºæ™¯ä¸­ï¼Œäººç±»çš„å‚ä¸æ˜¯ä¸å¯æˆ–ç¼ºçš„ã€‚æœ¬èŠ‚æ¢è®¨å¦‚ä½•åœ¨æ™ºèƒ½ä½“ç³»ç»Ÿä¸­ä¼˜é›…åœ°å¼•å…¥äººç±»ç›‘ç£ï¼Œå®ç°äººæœºåä½œçš„æœ€ä½³å¹³è¡¡ã€‚

### 5.4.1 ä¸ºä»€ä¹ˆéœ€è¦äººç±»ä»‹å…¥

### 5.4.2 æ™ºèƒ½ä½“è‡ªä¸»æ€§çš„è¾¹ç•Œ

å°½ç®¡ AI èƒ½åŠ›åœ¨å¿«é€Ÿæå‡ï¼Œä½†åœ¨ä»¥ä¸‹åœºæ™¯ä¸­ï¼Œäººç±»ä»‹å…¥ä»ç„¶æ˜¯å¿…è¦çš„ï¼š

| åœºæ™¯ç±»å‹ | åŸå›  | ç¤ºä¾‹ |
|----------|------|------|
| é«˜é£é™©å†³ç­– | é”™è¯¯æˆæœ¬è¿‡é«˜ | é‡‘èäº¤æ˜“ã€åŒ»ç–—è¯Šæ–­ |
| ä»·å€¼åˆ¤æ–­ | éœ€è¦ä¸»è§‚åå¥½ | åˆ›æ„è®¾è®¡ã€å“ç‰Œç­–ç•¥ |
| æ³•å¾‹è´£ä»» | éœ€è¦äººç±»ç­¾å­—ç¡®è®¤ | åˆåŒç­¾ç½²ã€é‡è¦å®¡æ‰¹ |
| ä¸ç¡®å®šæ€§é«˜ | æ¨¡å‹ä¿¡å¿ƒä¸è¶³ | æ¨¡ç³Šéœ€æ±‚ã€è¾¹ç¼˜æ¡ˆä¾‹ |
| å­¦ä¹ åé¦ˆ | æŒç»­ä¼˜åŒ–éœ€è¦ | é”™è¯¯çº æ­£ã€åå¥½å­¦ä¹  |

### 5.4.3 å®Œå…¨è‡ªä¸» vs äººæœºåä½œ

å…·ä½“ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
å®Œå…¨è‡ªä¸»æ¨¡å¼ï¼š
ç”¨æˆ· â†’ æ™ºèƒ½ä½“ â†’ æ‰§è¡Œ â†’ ç»“æœ
        â†‘
      (æ— ç›‘ç£)

äººæœºåä½œæ¨¡å¼ï¼š
ç”¨æˆ· â†’ æ™ºèƒ½ä½“ â†’ [æ£€æŸ¥ç‚¹] â†’ äººç±»ç¡®è®¤ â†’ æ‰§è¡Œ â†’ ç»“æœ
                    â†“
              (å¦‚éœ€ä¿®æ­£) â†’ æ™ºèƒ½ä½“é‡è¯•
```

### 5.4.4 äººæœºåä½œæ¨¡å¼è®¾è®¡

#### å®¡æ‰¹é—¨

åœ¨å…³é”®æ“ä½œå‰è®¾ç½®äººç±»å®¡æ‰¹èŠ‚ç‚¹ï¼š

```python
class ApprovalGate:
    def __init__(self, approval_type: str, timeout_hours: int = 24):
        self.approval_type = approval_type
        self.timeout_hours = timeout_hours
        
    async def request_approval(
        self, 
        action: str, 
        context: Dict
    ) -> ApprovalResult:
        # å‘é€å®¡æ‰¹è¯·æ±‚åˆ°äººç±»

        request_id = await send_approval_request(
            action=action,
            context=context,
            approval_type=self.approval_type
        )
        
        # ç­‰å¾…äººç±»å“åº”

        result = await wait_for_human_response(
            request_id, 
            timeout=self.timeout_hours * 3600
        )
        
        return result

# åœ¨å·¥ä½œæµä¸­ä½¿ç”¨

async def execute_high_risk_action(action: str):
    gate = ApprovalGate("financial_operation")
    
    approval = await gate.request_approval(
        action=f"æ‰§è¡Œè½¬è´¦: {action}",
        context={"amount": 10000, "recipient": "vendor_001"}
    )
    
    if approval.approved:
        return await perform_action(action)
    else:
        raise ActionRejected(approval.reason)
```

#### ç½®ä¿¡åº¦é˜ˆå€¼

å½“æ™ºèƒ½ä½“å¯¹å†³ç­–ä¿¡å¿ƒä¸è¶³æ—¶è‡ªåŠ¨è¯·æ±‚äººç±»å¸®åŠ©ï¼š

```python
class ConfidenceBasedHITL:
    def __init__(self, confidence_threshold: float = 0.8):
        self.threshold = confidence_threshold
        
    async def decide_with_human_backup(
        self, 
        question: str
    ) -> Tuple[str, str]:
        # æ™ºèƒ½ä½“ç”Ÿæˆå›ç­”å’Œç½®ä¿¡åº¦

        response, confidence = await agent.generate_with_confidence(question)
        
        if confidence >= self.threshold:
            return response, "agent"
        else:
            # ç½®ä¿¡åº¦ä¸è¶³ï¼Œè¯·æ±‚äººç±»å¸®åŠ©

            human_response = await request_human_input(
                question=question,
                agent_suggestion=response,
                agent_confidence=confidence,
                agent_confidence=confidence,
                message="æ™ºèƒ½ä½“ä¸ç¡®å®šæ­¤å›ç­”ï¼Œè¯·äººå·¥ç¡®è®¤æˆ–ä¿®æ­£"
            )
            return human_response, "human"
```

#### è¿­ä»£åé¦ˆå¾ªç¯

äººç±»æŒç»­æä¾›åé¦ˆï¼Œæ™ºèƒ½ä½“ä¸æ–­æ”¹è¿›ï¼š

```python
class IterativeFeedbackLoop:
    def __init__(self, max_iterations: int = 3):
        self.max_iterations = max_iterations
        
    async def refine_with_feedback(
        self, 
        task: str, 
        initial_output: str
    ) -> str:
        current_output = initial_output
        
        for i in range(self.max_iterations):
            # å±•ç¤ºå½“å‰ç»“æœç»™äººç±»

            feedback = await get_human_feedback(
                iteration=i + 1,
                current_output=current_output,
                prompt="è¯·æä¾›ä¿®æ”¹å»ºè®®ï¼Œæˆ–è¾“å…¥ 'approve' æ¥å—å½“å‰ç»“æœ"
            )
            
            if feedback.lower() == "approve":
                return current_output
                
            # æ ¹æ®åé¦ˆæ”¹è¿›

            current_output = await agent.refine(
                original=current_output,
                feedback=feedback
            )
            
        return current_output
```

### 5.4.5 LangGraph ä¸­çš„ HITL å®ç°

[LangGraph](https://langchain-ai.github.io/langgraph/) æä¾›äº†ä¼˜é›…çš„äººæœºäº¤äº’æ”¯æŒï¼š

```python
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.sqlite import SqliteSaver

# å®šä¹‰çŠ¶æ€

class AgentState(TypedDict):
    messages: List[str]
    pending_approval: bool
    human_feedback: Optional[str]

# å®šä¹‰èŠ‚ç‚¹

def agent_node(state: AgentState):
    # æ™ºèƒ½ä½“å¤„ç†é€»è¾‘

    response = agent.process(state["messages"])
    
    # åˆ¤æ–­æ˜¯å¦éœ€è¦äººç±»å®¡æ‰¹

    if is_high_risk(response):
        return {"pending_approval": True, "response": response}
    return {"response": response}

def human_approval_node(state: AgentState):
    # è¿™ä¸ªèŠ‚ç‚¹ä¼šæš‚åœï¼Œç­‰å¾…äººç±»è¾“å…¥

    # LangGraph çš„ interrupt_before æœºåˆ¶

    pass

# æ„å»ºå›¾

workflow = StateGraph(AgentState)
workflow.add_node("agent", agent_node)
workflow.add_node("human_review", human_approval_node)

# æ¡ä»¶è¾¹ï¼šå†³å®šæ˜¯å¦éœ€è¦äººç±»å®¡æ‰¹

workflow.add_conditional_edges(
    "agent",
    lambda s: "human_review" if s["pending_approval"] else END,
    {"human_review": "human_review", END: END}
)

# ä½¿ç”¨æ£€æŸ¥ç‚¹å®ç°ä¸­æ–­å’Œæ¢å¤

checkpointer = SqliteSaver.from_conn_string(":memory:")
app = workflow.compile(
    checkpointer=checkpointer,
    interrupt_before=["human_review"]  # åœ¨æ­¤èŠ‚ç‚¹å‰ä¸­æ–­
)
```

**ä½¿ç”¨å·¥ä½œæµ**ï¼š

```python
# å¯åŠ¨å·¥ä½œæµ

config = {"configurable": {"thread_id": "user_123"}}
result = app.invoke({"messages": ["è¯·å¸®æˆ‘è½¬è´¦ 10 ä¸‡å…ƒ"]}, config)

# å·¥ä½œæµåœ¨ human_review èŠ‚ç‚¹å‰æš‚åœ

# è·å–äººç±»è¾“å…¥åç»§ç»­

human_decision = get_human_input()  # "approved" æˆ– "rejected"

# æ¢å¤æ‰§è¡Œ

result = app.invoke(
    {"human_feedback": human_decision}, 
    config
)
```

#### æœ€ä½³å®è·µ

#### æ˜ç¡®ä»‹å…¥æ—¶æœº

å®šä¹‰æ¸…æ™°çš„ä»‹å…¥è§„åˆ™ï¼Œé¿å…è¿‡åº¦æ‰“æ‰°æˆ–ç›‘ç£ä¸è¶³ï¼š

```python
HITL_TRIGGERS = {
    "always": ["delete_production_data", "financial_transaction > 10000"],
    "confidence_based": ["customer_response", "content_generation"],
    "never": ["search_query", "read_document"]
}
```

#### æä¾›è¶³å¤Ÿä¸Šä¸‹æ–‡

äººç±»åšå†³ç­–æ—¶éœ€è¦å®Œæ•´ä¿¡æ¯ï¼š

```python
def format_approval_request(action: str, context: Dict) -> str:
    return f"""
    ğŸ“‹ éœ€è¦æ‚¨çš„å®¡æ‰¹
    
    æ“ä½œç±»å‹ï¼š{action}
    
    èƒŒæ™¯ä¿¡æ¯ï¼š
    - æ™ºèƒ½ä½“çš„æ¨ç†è¿‡ç¨‹ï¼š{context["reasoning"]}
    - ç½®ä¿¡åº¦ï¼š{context["confidence"]}
    - æ½œåœ¨é£é™©ï¼š{context["risks"]}
    
    é¢„æœŸç»“æœï¼š{context["expected_outcome"]}
    
    è¯·é€‰æ‹©ï¼š[âœ… æ‰¹å‡†] [âŒ æ‹’ç»] [âœï¸ ä¿®æ”¹åæ‰¹å‡†]
    """
```

#### æ”¯æŒå¼‚æ­¥å®¡æ‰¹

ä¸è¦è®©äººç±»ä¸€ç›´ç­‰å¾…ï¼Œæ”¯æŒç¨åå¤„ç†ï¼š

```python
class AsyncApprovalSystem:
    async def submit_for_approval(self, request: ApprovalRequest):
        # å­˜å‚¨è¯·æ±‚

        await self.db.save(request)
        
        # å‘é€é€šçŸ¥ï¼ˆé‚®ä»¶ã€Slackç­‰ï¼‰

        await self.notify(request.reviewer, request)
        
        # è¿”å›è¯·æ±‚IDï¼Œä¸é˜»å¡

        return request.id
        
    async def check_approval_status(self, request_id: str):
        request = await self.db.get(request_id)
        return request.status  # pending | approved | rejected
```

### 5.4.6 å°ç»“

äººæœºåä½œä¸æ˜¯å¯¹æ™ºèƒ½ä½“èƒ½åŠ›çš„å¦å®šï¼Œè€Œæ˜¯å¯¹å…¶èƒ½åŠ›è¾¹ç•Œçš„åŠ¡å®è®¤çŸ¥ã€‚é€šè¿‡åˆç†è®¾è®¡äººæœºåä½œ (HITL) æœºåˆ¶ï¼Œå¯ä»¥ï¼š

- åœ¨ä¿æŒæ•ˆç‡çš„åŒæ—¶ç¡®ä¿å®‰å…¨
- è®©äººç±»ä¸“æ³¨äºçœŸæ­£éœ€è¦åˆ¤æ–­åŠ›çš„å†³ç­–
- ä¸ºæ™ºèƒ½ä½“æä¾›æŒç»­å­¦ä¹ çš„åé¦ˆæ¥æº
- æ»¡è¶³åˆè§„å’Œå®¡è®¡è¦æ±‚

å…³é”®åœ¨äºæ‰¾åˆ° **è‡ªåŠ¨åŒ–ä¸äººå·¥ä»‹å…¥çš„æœ€ä½³å¹³è¡¡ç‚¹**â€”â€”æ—¢ä¸èƒ½è®©æ™ºèƒ½ä½“å®Œå…¨å¤±æ§ï¼Œä¹Ÿä¸èƒ½è®©äººç±»æˆä¸ºç“¶é¢ˆã€‚

æœ¬ç« ä»‹ç»äº†å¤šæ™ºèƒ½ä½“åä½œçš„æ ¸å¿ƒæ¨¡å¼ï¼Œä¸‹ä¸€ç« å°†æ·±å…¥æ¢è®¨æ™ºèƒ½ä½“ä¹‹é—´çš„é€šä¿¡æœºåˆ¶ã€‚

---

**ä¸‹ä¸€èŠ‚**: [æœ¬ç« å°ç»“](summary.md)
