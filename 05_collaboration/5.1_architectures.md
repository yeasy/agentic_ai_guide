## 5.1 协作架构：层级 vs 扁平 vs 动态

#### 为什么要多智能体 (Why Multi-Agent)?

正如一个人无法同时精通产品设计、后端架构、前端绘图和法律合规一样，指望单个 Agent (Prompt) 完成所有复杂任务是不现实的。
**单体 Agent (Monolithic Agent)** 面临以下瓶颈：
1.  **Context 限制**：所有角色的指令都塞进一个 System Prompt，会导致逻辑混乱，注意力分散。
2.  **幻觉风险**：缺乏检查机制，自己产生的错误自己信以为真。
3.  **能力专业化**：不同的任务需要不同的工具和 Prompt 策略。

**多智能体系统 (Multi-Agent Systems, MAS)** 通过**分工 (Specialization)** 和 **协作 (Collaboration)** 解决了这些问题。

---

#### 角色定义 (Role Playing / Persona)

每个 Agent 是一个独立的实体，拥有一张独特的“身份证”：
*   **Role**: 职位（如“首席架构师”）。
*   **Goal**: 具体的 KPI（如“设计可扩展的微服务架构”）。
*   **Backstory**: 背景故事（“你曾就职于 Google，崇尚简洁的代码风格”）。这能显著影响 LLM 的输出风格。
*   **Tools**: 仅该角色可用的特权工具（如 HR Agent 有读取工资单的权限，Coding Agent 没有）。

---

### 5.1.1 主流协作拓扑结构

#### 顺序式 (Sequential / Waterfall)
这是最简单的流水线模式，类似于传统的瀑布开发模型。
*   **流程**：`User` -> `Product Manager` -> `Tech Lead` -> `Developer` -> `Tester` -> `Result`。
*   **数据流**：上一个 Agent 的 Output 直接成为下一个 Agent 的 Input。
*   **适用场景**：SOP (标准作业程序) 非常明确的任务，如“写一篇文章并翻译成三种语言”。
*   **缺点**：这是一个开环系统，如果源头（PM）的需求理解错了，后面全错，缺乏反馈修正。

#### 层级式 (Hierarchical / Boss-Work)
引入一个 **Supervisor (Orchestrator)** 角色来动态分派任务。
*   **Supervisor**: 它是大脑，不干具体的活。它分析用户需求，决定：“这个问题需要先派 `SearchAgent` 去查资料，拿到结果后再派 `WriteAgent` 去写。”
*   **Worker**: 它是手脚，只负责执行 Manager 给的具体指令，并将结果汇报回去。
*   **LangChain 示例**：使用 `Routing` 机制，Supervisor 输出 `{"next": "WebSearch", "args": ...}`。
*   **适用场景**：复杂的、非线性的任务，需要根据中间结果动态调整下一步。

#### 联合协作式 (Joint Collaboration / Round Table)
类似于头脑风暴会议或 **ChatDev** 模式。
*   **流程**：多个 Agent 在一个共享的聊天室中自由发言。
*   **机制**：
    *   **广播**：Agent A 说话，BCD 都能听到。
    *   **轮次控制 (Turn-taking)**：需要一个规则（Controller）来决定下一个谁说话。比如：“如果 CEO 发言了，下一个必须是 CTO。”
*   **优劣**：利用“群体智慧”涌现出意想不到的创意，但容易跑题或陷入死循环争论。

#### 混合智能体架构 (Mixture of Agents, MoA)
这是一种前沿的**模型级**协作。
*   **Layer 1**: 这是一个由多个开源小模型（Llama-3, Qwen, Mistral）组成的层。它们并行处理同一个 Prompt，生成 3 个不同视角的回答。
*   **Layer 2**: 一个聚合模型（Aggregator，如 GPT-4）阅读 Layer 1 的所有回答，取长补短，合成最终答案。
*   **效果**：Together AI 的研究表明，MoA 架构能让开源模型组合达到 GPT-4 级别的性能。

### 5.1.2 本节小结
架构即政治。在设计 Agent 系统时，我们实际上是在设计一个人类组织的电子映射。选择**顺序式**还是**层级式**，取决于你的业务流程是更像工厂流水线（追求效率），还是像咨询公司项目组（追求灵活）。

---

**下一节**: [角色分工与 SOP 流程编排](5.2_roles_sop.md)